<!-- templates/dashboard.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - Supply Unlimited{% endblock %}

{% block auth_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<link rel="stylesheet" href="{% static 'sales/css/sales.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide-static@latest/font/lucide.min.css">
{% endblock %}

{% block content %}
<!-- Top Bar -->
<div class="top-bar">
    <div class="logo-section">
        <div class="logo-mini">SU</div>
        <div class="logo-text">Supply Unlimited</div>
    </div>
    <div class="user-section">
        <div class="user-info">
            <div class="user-name">{{ user.get_full_name|default:user.username }}</div>
            <div class="user-role">Administrator</div>
        </div>
        <a href="{% url 'logout' %}" class="btn btn-outline">Logout</a>
    </div>
</div>

<!-- Main Container -->
<div class="main-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Menu</h2>
        </div>
        <div class="sidebar-menu">
            <a href="#" class="menu-item active" onclick="showSection('dashboard'); return false;">
                <i data-lucide="home"></i>
                <span>Dashboard</span>
            </a>
            <a href="#" class="menu-item" onclick="showSection('companies'); return false;">
                <i data-lucide="building-2"></i>
                <span>Companies</span>
            </a>  
            <a href="#" class="menu-item" onclick="showSection('inventory'); return false;">
                <i data-lucide="package"></i>
                <span>Inventory</span>
            </a>
            <a href="#" class="menu-item" onclick="showSection('reports'); return false;">
                <i data-lucide="file-text"></i>
                <span>Reports</span>
            </a>
            <a href="#" class="menu-item" onclick="showSection('sales'); return false;">
                <i data-lucide="trending-up"></i>
                <span>Sales</span>
            </a>           
        </div>
    </div>

    <!-- Content Area -->
    <div class="content">
        <!-- Dashboard Section -->
        <div id="dashboard-section" class="content-section active">
            <div class="page-header">
                <h1>Dashboard</h1>
                <p>Supply Unlimited - European Operations</p>
            </div>

            <!-- Metrics Cards -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-header">
                        <div>
                            <div class="metric-value">€{{ metrics.total_revenue|floatformat:2 }}</div>
                            <div class="metric-label">Total Revenue</div>
                            <div class="metric-change">↑ 12.5% from last month</div>
                        </div>
                        <div class="metric-icon green">
                            <i data-lucide="euro"></i>
                        </div>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-header">
                        <div>
                            <div class="metric-value">{{ metrics.total_orders }}</div>
                            <div class="metric-label">Total Orders</div>
                            <div class="metric-change">↑ 8.2% from last month</div>
                        </div>
                        <div class="metric-icon blue">
                            <i data-lucide="shopping-cart"></i>
                        </div>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-header">
                        <div>
                            <div class="metric-value">{{ metrics.total_products }}</div>
                            <div class="metric-label">Products in Stock</div>
                            <div class="metric-change">↑ 3.1% from last month</div>
                        </div>
                        <div class="metric-icon orange">
                            <i data-lucide="package"></i>
                        </div>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-header">
                        <div>
                            <div class="metric-value">{{ metrics.active_customers }}</div>
                            <div class="metric-label">Active Customers</div>
                            <div class="metric-change">↑ 5.7% from last month</div>
                        </div>
                        <div class="metric-icon purple">
                            <i data-lucide="users"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3>Sales by Country</h3>
                        <p>Monthly revenue distribution</p>
                    </div>
                    <canvas id="salesChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-header">
                        <h3>Stock Distribution</h3>
                        <p>Product status overview</p>
                    </div>
                    <canvas id="stockChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Companies Section -->
        <div id="companies-section" class="content-section">
            <div class="page-header">
                <h1>Company Management</h1>
                <p>Manage companies and their relationships</p>
            </div>
            
            <div class="companies-controls">
                <div class="search-box">
                    <i data-lucide="search"></i>
                    <input type="text" id="companySearch" placeholder="Search companies..." onkeyup="filterCompanies()">
                </div>
                <button class="btn btn-primary" onclick="openCompanyModal()">
                    <i data-lucide="plus"></i> New Company
                </button>
                <button class="btn btn-outline" onclick="openMergeModal()">
                    <i data-lucide="git-merge"></i> Merge Companies
                </button>
            </div>

            <div id="companies-content">
                <div class="loading">Loading companies...</div>
            </div>
        </div>

        <!-- Other Sections (Placeholder) -->
        <div id="inventory-section" class="content-section">
            <div class="page-header">
                <h1>Inventory Management</h1>
                <p>Manage product inventory across all stores</p>
            </div>
        </div>

        <div id="sales-section" class="content-section">
            <div class="page-header">
                <h1>Sales Analytics</h1>
                <p>Analyze company performance, revenue, and market position</p>
            </div>

            <!-- Search Company Section -->
            <div class="search-container" style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                    <div style="width: 48px; height: 48px; background: #dbeafe; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        <i data-lucide="search" style="width: 24px; height: 24px; color: #2563eb;"></i>
                    </div>
                    <div>
                        <h3 style="font-size: 18px; font-weight: 600; color: #111827; margin: 0 0 4px 0;">Search Company</h3>
                        <p style="font-size: 14px; color: #6b7280; margin: 0;">Find detailed sales analytics and market insights</p>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 12px; align-items: flex-end;">
                    <div>
                        <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">Company Name</label>
                        <input type="text" id="sales-company-name" placeholder="Enter company name..." style="width: 100%; padding: 10px 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: inherit; outline: none;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">Sector</label>
                        <select id="sales-sector" style="width: 100%; padding: 10px 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: inherit; outline: none;">
                            <option value="all">All Sectors</option>
                            <option value="Technology">Technology</option>
                            <option value="Finance">Finance</option>
                            <option value="Retail">Retail</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">Country</label>
                        <select id="sales-country" style="width: 100%; padding: 10px 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: inherit; outline: none;">
                            <option value="all">All Countries</option>
                            <option value="Germany">Germany</option>
                            <option value="France">France</option>
                            <option value="Spain">Spain</option>
                        </select>
                    </div>
                    <button onclick="searchSalesCompany()" class="btn btn-primary" style="height: 40px; padding: 0 24px;">Search</button>
                </div>
            </div>

            <!-- Results Container -->
            <div id="sales-results-container" style="display: none;">
                <!-- Company Header -->
                <div id="sales-company-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; padding: 24px; color: white; margin-bottom: 24px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <div style="font-size: 24px; font-weight: 700;" id="sales-company-name-display"></div>
                    <div style="font-size: 14px; opacity: 0.9; margin-top: 4px;" id="sales-company-sector-display"></div>
                </div>

                <!-- KPI Cards -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;">
                    <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid #10b981;">
                        <div style="color: #6b7280; font-size: 13px; text-transform: uppercase; font-weight: 600; margin-bottom: 8px;">Revenue YTD</div>
                        <div style="font-size: 28px; font-weight: 700; color: #10b981;" id="sales-revenue-ytd">—</div>
                        <div style="font-size: 12px; color: #6b7280; margin-top: 8px;" id="sales-revenue-change">—</div>
                    </div>
                    <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid #2563eb;">
                        <div style="color: #6b7280; font-size: 13px; text-transform: uppercase; font-weight: 600; margin-bottom: 8px;">Profit YTD</div>
                        <div style="font-size: 28px; font-weight: 700; color: #2563eb;" id="sales-profit-ytd">—</div>
                        <div style="font-size: 12px; color: #6b7280; margin-top: 8px;" id="sales-profit-change">—</div>
                    </div>
                    <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid #ea580c;">
                        <div style="color: #6b7280; font-size: 13px; text-transform: uppercase; font-weight: 600; margin-bottom: 8px;">Prediction Next YTD</div>
                        <div style="font-size: 28px; font-weight: 700; color: #ea580c;" id="sales-prediction-ytd">—</div>
                        <div style="font-size: 12px; color: #6b7280; margin-top: 8px;" id="sales-prediction-growth">—</div>
                    </div>
                </div>

                <!-- Market Position -->
                <div style="background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; margin-bottom: 24px;">
                    <div style="padding: 24px; border-bottom: 1px solid #e5e7eb;">
                        <h3 style="font-size: 16px; font-weight: 600; color: #111827; margin: 0;">Market Position - Competitor Ranking</h3>
                    </div>
                    <div id="sales-competitors-table" style="overflow-x: auto;"></div>
                </div>

                <!-- Top Selling Products -->
                <div style="background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden;">
                    <div style="padding: 24px; border-bottom: 1px solid #e5e7eb;">
                        <h3 style="font-size: 16px; font-weight: 600; color: #111827; margin: 0;">Top Selling Products</h3>
                    </div>
                    <div id="sales-products-list" style="padding: 24px;"></div>
                </div>
            </div>

            <!-- Empty State -->
            <div id="sales-empty-state" style="text-align: center; padding: 60px 24px;">
                <div style="width: 80px; height: 80px; background: #f3f4f6; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                    <i data-lucide="search" style="width: 40px; height: 40px; color: #d1d5db;"></i>
                </div>
                <h3 style="font-size: 18px; font-weight: 600; color: #111827; margin: 0 0 8px 0;">Search for a Company</h3>
                <p style="color: #6b7280; margin: 0;">Enter a company name above to view detailed sales analytics and insights</p>
            </div>
        </div>

        <div id="orders-section" class="content-section">
            <div class="page-header">
                <h1>Orders</h1>
                <p>Manage customer orders</p>
            </div>
        </div>

        <div id="analytics-section" class="content-section">
            <div class="page-header">
                <h1>Analytics</h1>
                <p>Business intelligence and reports</p>
            </div>
        </div>

        <div id="customers-section" class="content-section">
            <div class="page-header">
                <h1>Customers</h1>
                <p>Customer relationship management</p>
            </div>
        </div>

        <div id="reports-section" class="content-section">
            <div class="page-header">
                <h1>Reports</h1>
                <p>Generate and export reports</p>
            </div>
        </div>
    </div>
</div>

<!-- Company Modal -->
<div id="companyModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>New Company</h2>
            <button class="modal-close" onclick="closeCompanyModal()">×</button>
        </div>
        <form id="companyForm" onsubmit="saveCompany(event)">
            <div class="form-group">
                <label>Company Name *</label>
                <input type="text" id="companyName" required>
            </div>
            <div class="form-group">
                <label>Country *</label>
                <input type="text" id="companyCountry" required>
            </div>
            <div class="form-group">
                <label>City *</label>
                <input type="text" id="companyCity" required>
            </div>
            <div class="form-group">
                <label>Status</label>
                <select id="companyStatus">
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                    <option value="pending">Pending</option>
                </select>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-outline" onclick="closeCompanyModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Company</button>
            </div>
        </form>
    </div>
</div>

<!-- Merge Companies Modal -->
<div id="mergeModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Merge Companies</h2>
            <button class="modal-close" onclick="closeMergeModal()">×</button>
        </div>
        <div style="margin-bottom: 16px; padding: 12px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
            <p style="font-size: 13px; color: #92400e;">⚠️ This will merge the source company into the target company. All stores and subsidiaries will be transferred.</p>
        </div>
        <form id="mergeForm" onsubmit="mergeCompanies(event)">
            <div class="form-group">
                <label>Source Company (To merge FROM) *</label>
                <select id="sourceCompany" required>
                    <option value="">Select a company...</option>
                </select>
            </div>
            <div style="text-align: center; margin: 16px 0;">
                <i data-lucide="arrow-down" style="width: 24px; height: 24px; color: #10b981;"></i>
            </div>
            <div class="form-group">
                <label>Target Company (To merge INTO) *</label>
                <select id="targetCompany" required>
                    <option value="">Select a company...</option>
                </select>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-outline" onclick="closeMergeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary" style="background: #ef4444;">Merge Companies</button>
            </div>
        </form>
    </div>
</div>

<!-- Warehouse Location Modal -->
<div id="warehouseModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <div>
                <h2 id="warehouseTitle">Warehouse Location</h2>
                <p id="warehouseSKU" style="font-size: 13px; color: #6b7280; margin-top: 4px;"></p>
            </div>
            <button class="modal-close" onclick="closeWarehouseModal()">×</button>
        </div>
        
        <div id="warehouseContent" style="max-height: 500px; overflow-y: auto;">
            <div class="loading" style="text-align: center; padding: 40px;">Carregando localização...</div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="{% static 'js/dashboard.js' %}"></script>
{% endblock %}
