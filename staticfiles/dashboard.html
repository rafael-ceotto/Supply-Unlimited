<!-- templates/dashboard.html -->
{% extends 'base.html' %}
{% load static %}
{% load form_tags %}

{% if not user.is_authenticated %}
  {% comment %} Se nÃ£o estiver autenticado, redirecionar para login {% endcomment %}
  <script>
    window.location.href = "{% url 'login' %}";
  </script>
{% endif %}

{% block title %}Dashboard - Supply Unlimited{% endblock %}

{% block auth_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<link rel="stylesheet" href="{% static 'css/dashboard-redesign.css' %}">
<link rel="stylesheet" href="{% static 'sales/css/sales.css' %}">
<link rel="stylesheet" href="{% static 'css/ai-reports.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide-static@latest/font/lucide.min.css">
{% endblock %}

{% block content %}
<!-- Top Bar -->
<div class="top-bar">
    <div class="logo-section">
        <svg viewBox="0 0 200 200" class="logo-svg-dashboard" xmlns="http://www.w3.org/2000/svg" style="width: 75px; height: 75px;">
            <g class="ellipse-group-1">
                <ellipse cx="100" cy="100" rx="85" ry="50" fill="none" stroke="rgba(34, 197, 94, 0.4)" stroke-width="2"/>
                <circle cx="185" cy="100" r="4" fill="#22c55e"/>
                <circle cx="100" cy="150" r="4" fill="#22c55e"/>
                <circle cx="15" cy="100" r="4" fill="#22c55e"/>
                <circle cx="100" cy="50" r="4" fill="#22c55e"/>
            </g>
            <g class="ellipse-group-2">
                <ellipse cx="100" cy="100" rx="85" ry="50" fill="none" stroke="rgba(34, 197, 94, 0.4)" stroke-width="2"/>
                <circle cx="185" cy="100" r="4" fill="#16a34a"/>
                <circle cx="100" cy="150" r="4" fill="#16a34a"/>
                <circle cx="15" cy="100" r="4" fill="#16a34a"/>
                <circle cx="100" cy="50" r="4" fill="#16a34a"/>
            </g>
            <circle cx="100" cy="100" r="40" fill="white" stroke="#22c55e" stroke-width="3"/>
            <text x="100" y="100" text-anchor="middle" dominant-baseline="central" font-size="32" font-weight="bold" fill="#16a34a">SU</text>
        </svg>
        <div class="logo-text">Supply Unlimited</div>
    </div>
    <button class="hamburger-menu" id="hamburgerMenu" title="Toggle menu">
        <i data-lucide="menu" class="icon-md"></i>
    </button>
    <div class="user-section">
        <div class="user-info">
            {% if user.is_authenticated %}
                <div class="user-name">{{ user.get_full_name|default:user.username }}</div>
            {% endif %}
        </div>
        <a href="{% url 'logout' %}" onclick="clearStorageOnLogout()" class="logout-link">
            <i data-lucide="log-out" class="icon-md"></i>
        </a>
    </div>
</div>

<!-- Main Container -->
<div class="main-container">
    <!-- Sidebar -->
    <div class="sidebar">
        
        <div class="sidebar-menu">
            <a href="#" class="menu-item active" onclick="showSection('dashboard'); return false;">
                <i data-lucide="home"></i>
                <span>Dashboard</span>
            </a>
            <a href="#" class="menu-item" onclick="showSection('companies'); return false;">
                <i data-lucide="building-2"></i>
                <span>Companies</span>
            </a>  
            <a href="#" class="menu-item" onclick="showSection('inventory'); return false;">
                <i data-lucide="package"></i>
                <span>Inventory</span>
            </a>
            <a href="#" class="menu-item" onclick="showSection('reports'); return false;">
                <i data-lucide="file-text"></i>
                <span>Analytics</span>
                <div class="submenu">
                    <a href="#" class="submenu-item" onclick="showSubsection('reports', 'analytics'); return false;">
                        <i data-lucide="trending-up" class="icon-sm icon-inline icon-mr-md"></i>Sales Analytics
                    </a>
                    <a href="#" class="submenu-item" onclick="showSubsection('reports', 'reports'); return false;">
                        <i data-lucide="file-text" class="icon-sm icon-inline icon-mr-md"></i>Other Reports
                    </a>
                </div>
            </a>
            <a href="#" class="menu-item" onclick="showSection('ai-reports'); return false;">
                <i data-lucide="sparkles"></i>
                <span>AI Reports</span>
            </a>
            <a href="#" class="menu-item menu-item-bottom" onclick="showSection('settings'); return false;">
                <i data-lucide="settings"></i>
                <span>Settings</span>
            </a>           
        </div>
    </div>

    <!-- Content Area -->
    <div class="content">
        <!-- Dashboard Section -->
        <div id="dashboard-section" class="content-section active">
            <!-- Dashboard Hero Section -->
            <div class="dashboard-hero">
                <h1>ðŸ“Š Welcome back, {{ user.get_full_name|default:user.username }}!</h1>
                <p>Here's what's happening with your supply chain today</p>
                <div class="dashboard-hero-date" id="heroDate"></div>
            </div>

            <!-- Section: Key Metrics -->
            <div class="metrics-section">
                <div class="section-header">
                    <h2 class="section-title">Key Metrics</h2>
                    <p class="section-subtitle">Last 30 Days</p>
                </div>

                <!-- Metrics Grid -->
                <div class="metrics-grid">
                    <div class="metric-card green">
                        <div class="metric-header">
                            <div class="metric-info">
                                <div class="metric-label">Total Revenue</div>
                                <div class="metric-value">â‚¬{{ metrics.total_revenue|european_format:2 }}</div>
                            </div>
                            <div class="metric-icon green">
                                <i data-lucide="euro"></i>
                            </div>
                        </div>
                        <div class="metric-footer">
                            <div class="metric-change">â†‘ 12.5%</div>
                            <div class="metric-trend">from last month</div>
                        </div>
                    </div>

                    <div class="metric-card blue">
                        <div class="metric-header">
                            <div class="metric-info">
                                <div class="metric-label">Total Orders</div>
                                <div class="metric-value">{{ metrics.total_orders }}</div>
                            </div>
                            <div class="metric-icon blue">
                                <i data-lucide="shopping-cart"></i>
                            </div>
                        </div>
                        <div class="metric-footer">
                            <div class="metric-change">â†‘ 8.2%</div>
                            <div class="metric-trend">from last month</div>
                        </div>
                    </div>

                    <div class="metric-card orange">
                        <div class="metric-header">
                            <div class="metric-info">
                                <div class="metric-label">in Stock</div>
                                <div class="metric-value">{{ metrics.total_products }}</div>
                            </div>
                            <div class="metric-icon orange">
                                <i data-lucide="package"></i>
                            </div>
                        </div>
                        <div class="metric-footer">
                            <div class="metric-change">â†‘ 3.1%</div>
                            <div class="metric-trend">from last month</div>
                        </div>
                    </div>

                    <div class="metric-card purple">
                        <div class="metric-header">
                            <div class="metric-info">
                                <div class="metric-label">Active Customers</div>
                                <div class="metric-value">{{ metrics.active_customers }}</div>
                            </div>
                            <div class="metric-icon purple">
                                <i data-lucide="users"></i>
                            </div>
                        </div>
                        <div class="metric-footer">
                            <div class="metric-change">â†‘ 5.7%</div>
                            <div class="metric-trend">from last month</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section: Quick Actions -->
            <div class="quick-actions">
                <span class="quick-action-label">Quick Actions</span>
                <button class="quick-action-btn" onclick="showSection('companies')">
                    <i data-lucide="building-2" class="icon-sm"></i>
                    View Companies
                </button>
                <button class="quick-action-btn" onclick="showSection('inventory')">
                    <i data-lucide="package" class="icon-sm"></i>
                    Manage Inventory
                </button>
                <button class="quick-action-btn" onclick="showSection('ai-reports')">
                    <i data-lucide="sparkles" style="width: 16px; height: 16px;"></i>
                    Generate Report
                </button>
            </div>

            <!-- Section: Charts & Analytics -->
            <div class="charts-section">
                <div class="section-header">
                    <h2 class="section-title">Analytics & Insights</h2>
                    <p class="section-subtitle">Monthly Trends</p>
                </div>

                <div class="charts-grid">
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3>Sales by Country</h3>
                            <p>Monthly revenue distribution</p>
                        </div>
                        <canvas id="salesChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3>Stock Distribution</h3>
                            <p>Product status overview</p>
                        </div>
                        <canvas id="stockChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Companies Section -->
        <div id="companies-section" class="content-section">
            <div class="companies-controls">
                <div class="search-box">
                    <i data-lucide="search"></i>
                    <input type="text" id="companySearch" placeholder="Search companies..." onkeyup="filterCompanies()">
                </div>
                <button class="btn btn-primary" onclick="openCompanyModal()">
                    <i data-lucide="plus"></i> New Company
                </button>
                <button class="btn btn-outline" onclick="openMergeModal()">
                    <i data-lucide="git-merge"></i> Merge Companies
                </button>
            </div>

            <div id="companies-content">
                <div class="loading">Loading companies...</div>
            </div>
        </div>

        <!-- Other Sections (Placeholder) -->
        <div id="inventory-section" class="content-section">
            <!-- Search & Filters -->
            <div class="filters-container">
                <h3 style="margin-bottom: 16px; font-size: 18px; font-weight: 600; color: #1f2937;">Search Inventory</h3>
                <div class="filters-row">
                    <div class="search-box">
                        <i data-lucide="search"></i>
                        <input type="text" id="searchInput" placeholder="Search products, SKU, category..." onkeyup="filterInventory()">
                    </div>
                    <div class="filter-divider"></div>
                    <div class="filter-group">
                        <select id="categoryFilter" onchange="filterInventory()" class="filter-select">
                            <option value="all">All Categories</option>
                        </select>
                        <select id="stockFilter" onchange="filterInventory()" class="filter-select">
                            <option value="all">All Stock Status</option>
                            <option value="in-stock">In Stock</option>
                            <option value="low-stock">Low Stock</option>
                            <option value="out-of-stock">Out of Stock</option>
                        </select>
                        <select id="priceFilter" onchange="filterInventory()" class="filter-select">
                            <option value="all">All Prices</option>
                            <option value="0-100">â‚¬0 - â‚¬100</option>
                            <option value="100-500">â‚¬100 - â‚¬500</option>
                            <option value="500-1000">â‚¬500 - â‚¬1000</option>
                            <option value="1000+">â‚¬1000+</option>
                        </select>
                    </div>
                    
                </div>
            </div>

            <!-- Inventory Table -->
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title-section">
                        <h3>Live Stock Inventory</h3>
                        <p>Real-time stock updates across European stores</p>
                    </div>
                    <div class="table-actions">
                        <button class="btn btn-outline" onclick="exportInventory('csv')" title="Export as CSV">
                            <i data-lucide="table" class="icon-sm"></i> CSV
                        </button>
                        <button class="btn btn-outline" onclick="exportInventory('json')" title="Export as JSON">
                            <i data-lucide="file-json" class="icon-sm"></i> JSON
                        </button>
                        <button class="btn btn-outline" onclick="exportInventory('parquet')" title="Export as Parquet">
                            <i data-lucide="database" class="icon-sm"></i> Parquet
                        </button>
                    </div>
                </div>
                <div id="inventory-table">
                    <div class="loading">Loading inventory data...</div>
                </div>
            </div>
        </div>

        <div id="reports-section" class="content-section">
            <!-- Sub-tabs for Reports -->
            <div class="report-tabs-wrapper">
                <button class="tab-button-styled tab-button-active" onclick="showSubsection('reports', 'analytics'); return false;">
                    <i data-lucide="trending-up" class="icon-sm icon-inline icon-mr-sm"></i>Sales Analytics
                </button>
                <button class="tab-button-styled tab-button-inactive" onclick="showSubsection('reports', 'risk'); return false;">
                    <i data-lucide="alert-triangle" class="icon-sm icon-inline icon-mr-sm"></i>Risk Report
                </button>
                <button class="tab-button-styled tab-button-inactive" onclick="showSubsection('reports', 'sustainability'); return false;">
                    <i data-lucide="leaf" class="icon-sm icon-inline icon-mr-sm"></i>Sustainability
                </button>
                <button class="tab-button-styled tab-button-inactive" onclick="showSubsection('reports', 'inventory'); return false;">
                    <i data-lucide="package" class="icon-sm icon-inline icon-mr-sm"></i>Inventory Report
                </button>
            </div>

            <!-- Sales Analytics Sub-section -->
            <div id="subsection-analytics" style="display: block;">
                <div class="page-header-flex">
                    <div class="page-header-icon">
                        <i data-lucide="trending-up" class="icon-lg"></i>
                    </div>
                    <div class="page-header-title">
                        <h2>Sales Analytics</h2>
                        <p>Company Performance & Market Insights</p>
                    </div>
                </div>
                <!-- Search Company Section -->
                <div class="search-form-wrapper">
                    <h3 class="table-section-header h3" style="margin-bottom: 12px;">Search Company</h3>
                    <div class="search-form-grid">
                        <div>
                            <label class="search-form-label">Company Name</label>
                            <input type="text" id="sales-company-name" placeholder="Enter company name..." class="search-form-input">
                        </div>
                        <div>
                            <label class="search-form-label">Sector</label>
                            <select id="sales-sector" class="search-form-select">
                                <option value="all">All Sectors</option>
                                <option value="Technology">Technology</option>
                                <option value="Finance">Finance</option>
                                <option value="Retail">Retail</option>
                            </select>
                        </div>
                        <div>
                            <label class="search-form-label">Country</label>
                            <select id="sales-country" class="search-form-select">
                                <option value="all">All Countries</option>
                                <option value="Germany">Germany</option>
                                <option value="France">France</option>
                                <option value="Spain">Spain</option>
                            </select>
                        </div>
                        <button onclick="searchSalesCompany()" class="btn btn-primary" style="height: 40px; padding: 0 24px;">Search</button>
                    </div>
                </div>

                <!-- Results Container -->
                <div id="sales-results-container" class="sales-results-container">
                    <!-- Company Header -->
                    <div id="sales-company-header" class="sales-company-header">
                        <div class="sales-company-header-name" id="sales-company-name-display"></div>
                        <div class="sales-company-header-sector" id="sales-company-sector-display"></div>
                    </div>

                    <!-- KPI Cards -->
                    <div class="kpi-cards-grid">
                        <div class="kpi-card">
                            <div class="kpi-label">Revenue YTD</div>
                            <div class="kpi-value" id="sales-revenue-ytd">â€”</div>
                            <div class="kpi-change" id="sales-revenue-change">â€”</div>
                        </div>
                        <div class="kpi-card kpi-card-blue">
                            <div class="kpi-label">Profit YTD</div>
                            <div class="kpi-value kpi-value-blue" id="sales-profit-ytd">â€”</div>
                            <div class="kpi-change" id="sales-profit-change">â€”</div>
                        </div>
                        <div class="kpi-card kpi-card-orange">
                            <div class="kpi-label">Prediction Next YTD</div>
                            <div class="kpi-value kpi-value-orange" id="sales-prediction-ytd">â€”</div>
                            <div class="kpi-change" id="sales-prediction-growth">â€”</div>
                        </div>
                    </div>

                    <!-- Market Position -->
                    <div class="table-section">
                        <div class="table-section-header">
                            <h3>Market Position - Competitor Ranking</h3>
                        </div>
                        <div id="sales-competitors-table" style="overflow-x: auto;"></div>
                    </div>

                    <!-- Top Selling Products -->
                    <div class="table-section">
                        <div class="table-section-header">
                            <h3>Top Selling Products</h3>
                        </div>
                        <div id="sales-products-list" style="padding: 24px;"></div>
                    </div>
                </div>

                <!-- Empty State -->
                <div id="sales-empty-state" style="text-align: center; padding: 60px 24px;">
                    <div style="width: 80px; height: 80px; background: #f3f4f6; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                        <i data-lucide="search" style="width: 40px; height: 40px; color: #d1d5db;"></i>
                    </div>
                    <h3 style="font-size: 18px; font-weight: 600; color: #111827; margin: 0 0 8px 0;">Search for a Company</h3>
                    <p style="color: #6b7280; margin: 0;">Enter a company name above to view detailed sales analytics and insights</p>
                </div>
            </div>

            <!-- Other Reports Sub-section -->
            <div id="subsection-risk" style="display: none;">
                <div class="page-header" style="margin-bottom: 24px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 40px; height: 40px; background: #fee2e2; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                            <i data-lucide="alert-triangle" style="width: 24px; height: 24px; color: #dc2626;"></i>
                        </div>
                        <div>
                            <h2 style="font-size: 24px; font-weight: 700; margin: 0;">Risk & Exceptions Report</h2>
                            <p style="color: #6b7280; margin: 0; font-size: 14px;">Supply Chain Risk Analysis</p>
                        </div>
                    </div>
                </div>

                <!-- Risk Filters -->
                <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
                    <div>
                        <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">Period</label>
                        <select id="risk-period-filter" onchange="updateRiskData()" style="width: 100%; padding: 10px 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: inherit; outline: none;">
                            <option value="7">Last 7 Days</option>
                            <option value="30" selected>Last 30 Days</option>
                            <option value="90">Last 90 Days</option>
                            <option value="365">Year to Date</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">Country</label>
                        <select id="risk-country-filter" onchange="updateRiskData()" style="width: 100%; padding: 10px 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: inherit; outline: none;">
                            <option value="all" selected>All Countries</option>
                            <option value="Germany">Germany</option>
                            <option value="France">France</option>
                            <option value="Italy">Italy</option>
                            <option value="Spain">Spain</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">SKU</label>
                        <input type="text" id="risk-sku-filter" placeholder="Filter by SKU..." onchange="updateRiskData()" style="width: 100%; padding: 10px 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: inherit; outline: none;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">Supplier</label>
                        <select id="risk-supplier-filter" onchange="updateRiskData()" style="width: 100%; padding: 10px 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: inherit; outline: none;">
                            <option value="all" selected>All Suppliers</option>
                            <option value="Supplier A">Supplier A</option>
                            <option value="Supplier B">Supplier B</option>
                        </select>
                    </div>
                </div>

                <!-- Risk KPI Cards -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                    <div style="background: white; border-radius: 12px; padding: 24px; border-left: 4px solid #dc2626; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <div style="width: 40px; height: 40px; background: #fee2e2; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                <i data-lucide="alert-triangle" style="width: 20px; height: 20px; color: #dc2626;"></i>
                            </div>
                            <div style="font-size: 13px; font-weight: 600; color: #6b7280;">SKUs at Risk</div>
                        </div>
                        <div id="risk-kpi-1" style="font-size: 32px; font-weight: 700; color: #111827; margin-bottom: 4px;">23.5%</div>
                        <div style="font-size: 13px; color: #dc2626;">Stock out risk</div>
                    </div>
                    <div style="background: white; border-radius: 12px; padding: 24px; border-left: 4px solid #f97316; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <div style="width: 40px; height: 40px; background: #fef3c7; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                <i data-lucide="clock" style="width: 20px; height: 20px; color: #f97316;"></i>
                            </div>
                            <div style="font-size: 13px; font-weight: 600; color: #6b7280;">High Lead Time</div>
                        </div>
                        <div id="risk-kpi-2" style="font-size: 32px; font-weight: 700; color: #111827; margin-bottom: 4px;">156</div>
                        <div style="font-size: 13px; color: #f97316;">Orders above P95</div>
                    </div>
                    <div style="background: white; border-radius: 12px; padding: 24px; border-left: 4px solid #eab308; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <div style="width: 40px; height: 40px; background: #fef08a; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                <i data-lucide="truck" style="width: 20px; height: 20px; color: #eab308;"></i>
                            </div>
                            <div style="font-size: 13px; font-weight: 600; color: #6b7280;">Critical Suppliers</div>
                        </div>
                        <div id="risk-kpi-3" style="font-size: 32px; font-weight: 700; color: #111827; margin-bottom: 4px;">8</div>
                        <div style="font-size: 13px; color: #eab308;">High dependency</div>
                    </div>
                    <div style="background: white; border-radius: 12px; padding: 24px; border-left: 4px solid #22c55e; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <div style="width: 40px; height: 40px; background: #dcfce7; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                <i data-lucide="trending-down" style="width: 20px; height: 20px; color: #22c55e;"></i>
                            </div>
                            <div style="font-size: 13px; font-weight: 600; color: #6b7280;">OTIF Performance</div>
                        </div>
                        <div id="risk-kpi-4" style="font-size: 32px; font-weight: 700; color: #111827; margin-bottom: 4px;">87.2%</div>
                        <div style="font-size: 13px; color: #22c55e;">On-time, in-full</div>
                    </div>
                </div>

                <!-- Risk Charts -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                    <!-- SKUs at Risk by Country -->
                    <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <h3 style="font-size: 16px; font-weight: 600; color: #111827; margin: 0 0 20px 0;">SKUs at Risk by Country</h3>
                        <canvas id="riskCountryChart" style="max-height: 300px;"></canvas>
                    </div>

                    <!-- Delivery by Logistics Calendar -->
                    <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <h3 style="font-size: 16px; font-weight: 600; color: #111827; margin: 0 0 20px 0;">Delivery by Logistics Calendar</h3>
                        <canvas id="deliveryCalendarChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>

                <!-- Risk Exceptions Table -->
                <div class="table-wrapper card">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid var(--border-color);">
                        <i data-lucide="alert-octagon" style="width: 20px; height: 20px; color: #dc2626;"></i>
                        <h3 style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin: 0;">Top Exceptions</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th style="text-align: left;">SKU</th>
                                <th style="text-align: left;">Country</th>
                                <th style="text-align: left;">Product Type</th>
                                <th style="text-align: left;">Problem</th>
                                <th style="text-align: left;">Impact (â‚¬)</th>
                                <th style="text-align: center;">Severity</th>
                            </tr>
                        </thead>
                        <tbody id="risk-exceptions-table">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Sustainability Sub-section -->
            <div id="subsection-sustainability" style="display: none;">
                <div class="page-header" style="margin-bottom: 24px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 40px; height: 40px; background: #dcfce7; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                            <i data-lucide="leaf" style="width: 24px; height: 24px; color: #22c55e;"></i>
                        </div>
                        <div>
                            <h2 style="font-size: 24px; font-weight: 700; margin: 0;">COâ‚‚ & Sustainability Report</h2>
                            <p style="color: #6b7280; margin: 0; font-size: 14px;">Carbon Footprint Analysis & Environmental Impact</p>
                        </div>
                    </div>
                </div>

                <!-- Sustainability Filters -->
                <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                    <div>
                        <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">Period</label>
                        <select id="sust-period-filter" onchange="updateSustainabilityData()" style="width: 100%; padding: 10px 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: inherit; outline: none;">
                            <option value="7">Last 7 Days</option>
                            <option value="30" selected>Last 30 Days</option>
                            <option value="90">Last 90 Days</option>
                            <option value="365">Year to Date</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">Country</label>
                        <select id="sust-country-filter" onchange="updateSustainabilityData()" style="width: 100%; padding: 10px 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: inherit; outline: none;">
                            <option value="all" selected>All Countries</option>
                            <option value="Germany">Germany</option>
                            <option value="France">France</option>
                            <option value="Italy">Italy</option>
                            <option value="Spain">Spain</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">Transport Mode</label>
                        <select id="sust-mode-filter" onchange="updateSustainabilityData()" style="width: 100%; padding: 10px 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: inherit; outline: none;">
                            <option value="all" selected>All Modes</option>
                            <option value="Road">Road</option>
                            <option value="Rail">Rail</option>
                            <option value="Sea">Sea</option>
                            <option value="Air">Air</option>
                        </select>
                    </div>
                </div>

                <!-- Sustainability KPI Cards -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                    <div style="background: white; border-radius: 12px; padding: 24px; border-left: 4px solid #8b5cf6; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <div style="width: 40px; height: 40px; background: #ede9fe; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                <i data-lucide="gauge" style="width: 20px; height: 20px; color: #8b5cf6;"></i>
                            </div>
                            <div style="font-size: 13px; font-weight: 600; color: #6b7280;">Total COâ‚‚</div>
                        </div>
                        <div id="sust-kpi-1" style="font-size: 32px; font-weight: 700; color: #111827; margin-bottom: 4px;">284,500</div>
                        <div style="font-size: 13px; color: #8b5cf6;">kg COâ‚‚e</div>
                    </div>
                    <div style="background: white; border-radius: 12px; padding: 24px; border-left: 4px solid #f59e0b; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <div style="width: 40px; height: 40px; background: #fef3c7; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                <i data-lucide="package" style="width: 20px; height: 20px; color: #f59e0b;"></i>
                            </div>
                            <div style="font-size: 13px; font-weight: 600; color: #6b7280;">COâ‚‚ per Shipment</div>
                        </div>
                        <div id="sust-kpi-2" style="font-size: 32px; font-weight: 700; color: #111827; margin-bottom: 4px;">42.3</div>
                        <div style="font-size: 13px; color: #f59e0b;">kg COâ‚‚e/shipment</div>
                    </div>
                    <div style="background: white; border-radius: 12px; padding: 24px; border-left: 4px solid #06b6d4; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <div style="width: 40px; height: 40px; background: #cffafe; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                <i data-lucide="zap" style="width: 20px; height: 20px; color: #06b6d4;"></i>
                            </div>
                            <div style="font-size: 13px; font-weight: 600; color: #6b7280;">Renewable Energy</div>
                        </div>
                        <div id="sust-kpi-3" style="font-size: 32px; font-weight: 700; color: #111827; margin-bottom: 4px;">0.18</div>
                        <div style="font-size: 13px; color: #06b6d4;">% of operations</div>
                    </div>
                    <div style="background: white; border-radius: 12px; padding: 24px; border-left: 4px solid #10b981; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <div style="width: 40px; height: 40px; background: #dcfce7; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                <i data-lucide="trending-down" style="width: 20px; height: 20px; color: #10b981;"></i>
                            </div>
                            <div style="font-size: 13px; font-weight: 600; color: #6b7280;">Load Reduction</div>
                        </div>
                        <div id="sust-kpi-4" style="font-size: 32px; font-weight: 700; color: #111827; margin-bottom: 4px;">34.5%</div>
                        <div style="font-size: 13px; color: #10b981;">vs. last period</div>
                    </div>
                </div>

                <!-- Sustainability Charts -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                    <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <h3 style="font-size: 16px; font-weight: 600; color: #111827; margin: 0 0 20px 0;">COâ‚‚ Intensity by Country</h3>
                        <canvas id="co2CountryChart" style="max-height: 300px;"></canvas>
                    </div>
                    <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <h3 style="font-size: 16px; font-weight: 600; color: #111827; margin: 0 0 20px 0;">Emissions by Transport Mode</h3>
                        <canvas id="emissionsModeChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>

                <!-- CO2 Trend Chart -->
                <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px;">
                    <h3 style="font-size: 16px; font-weight: 600; color: #111827; margin: 0 0 20px 0;">COâ‚‚ Emissions Trend vs Target</h3>
                    <canvas id="co2TrendChart" style="max-height: 250px;"></canvas>
                </div>

                <!-- Sustainability Metrics Bottom Cards -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                    <div style="background: linear-gradient(135deg, #dcfce7 0%, #d1fae5 100%); border-radius: 12px; padding: 24px; border-left: 4px solid #10b981;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <i data-lucide="leaf" style="width: 24px; height: 24px; color: #059669;"></i>
                            <h4 style="font-size: 14px; font-weight: 600; color: #065f46; margin: 0;">Saved by Modal Split</h4>
                        </div>
                        <div style="font-size: 28px; font-weight: 700; color: #047857;">52,380 kg</div>
                        <p style="font-size: 12px; color: #065f46; margin: 8px 0 0 0;">COâ‚‚e reduction through smart routing</p>
                    </div>
                    <div style="background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%); border-radius: 12px; padding: 24px; border-left: 4px solid #dc2626;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <i data-lucide="award" style="width: 24px; height: 24px; color: #991b1b;"></i>
                            <h4 style="font-size: 14px; font-weight: 600; color: #7f1d1d; margin: 0;">COâ‚‚ Offset</h4>
                        </div>
                        <div style="font-size: 28px; font-weight: 700; color: #b91c1c;">12,980 kg</div>
                        <p style="font-size: 12px; color: #7f1d1d; margin: 8px 0 0 0;">Purchased carbon credits</p>
                    </div>
                    <div style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); border-radius: 12px; padding: 24px; border-left: 4px solid #4f46e5;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <i data-lucide="globe" style="width: 24px; height: 24px; color: #312e81;"></i>
                            <h4 style="font-size: 14px; font-weight: 600; color: #3730a3; margin: 0;">Carbon Footprint</h4>
                        </div>
                        <div style="font-size: 28px; font-weight: 700; color: #4f46e5;">164,000 kg</div>
                        <p style="font-size: 12px; color: #3730a3; margin: 8px 0 0 0;">Current period total</p>
                    </div>
                </div>
            </div>

            <!-- Inventory Report Sub-section -->
            <div id="subsection-inventory" style="display: none;">
                <div class="page-header" style="margin-bottom: 24px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 40px; height: 40px; background: #e0e7ff; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                            <i data-lucide="package" style="width: 24px; height: 24px; color: #4f46e5;"></i>
                        </div>
                        <div>
                            <h2 style="font-size: 24px; font-weight: 700; margin: 0;">Inventory & Working Capital Report</h2>
                            <p style="color: #6b7280; margin: 0; font-size: 14px;">Stock Levels & Warehouse Analysis</p>
                        </div>
                    </div>
                </div>

                <!-- Inventory Filters -->
                <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                    <div>
                        <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">Period</label>
                        <select id="inv-period-filter" onchange="updateInventoryData()" style="width: 100%; padding: 10px 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: inherit; outline: none;">
                            <option value="7">Last 7 Days</option>
                            <option value="30" selected>Last 30 Days</option>
                            <option value="90">Last 90 Days</option>
                            <option value="365">Year to Date</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">Country</label>
                        <select id="inv-country-filter" onchange="updateInventoryData()" style="width: 100%; padding: 10px 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: inherit; outline: none;">
                            <option value="all" selected>All Countries</option>
                            <option value="Germany">Germany</option>
                            <option value="France">France</option>
                            <option value="Italy">Italy</option>
                            <option value="Spain">Spain</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">Breakdown Level</label>
                        <select id="inv-breakdown-filter" onchange="updateInventoryData()" style="width: 100%; padding: 10px 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: inherit; outline: none;">
                            <option value="warehouse" selected>By Warehouse</option>
                            <option value="product">By Product</option>
                            <option value="region">By Region</option>
                        </select>
                    </div>
                </div>

                <!-- Inventory KPI Cards -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                    <div style="background: white; border-radius: 12px; padding: 24px; border-left: 4px solid #3b82f6; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <div style="width: 40px; height: 40px; background: #dbeafe; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                <i data-lucide="boxes" style="width: 20px; height: 20px; color: #3b82f6;"></i>
                            </div>
                            <div style="font-size: 13px; font-weight: 600; color: #6b7280;">Total Inventory</div>
                        </div>
                        <div id="inv-kpi-1" style="font-size: 32px; font-weight: 700; color: #111827; margin-bottom: 4px;">42.3</div>
                        <div style="font-size: 13px; color: #3b82f6;">Million units</div>
                    </div>
                    <div style="background: white; border-radius: 12px; padding: 24px; border-left: 4px solid #10b981; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <div style="width: 40px; height: 40px; background: #dcfce7; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                <i data-lucide="check-circle" style="width: 20px; height: 20px; color: #10b981;"></i>
                            </div>
                            <div style="font-size: 13px; font-weight: 600; color: #6b7280;">Stockout Risk</div>
                        </div>
                        <div id="inv-kpi-2" style="font-size: 32px; font-weight: 700; color: #111827; margin-bottom: 4px;">8.6k</div>
                        <div style="font-size: 13px; color: #10b981;">SKUs</div>
                    </div>
                    <div style="background: white; border-radius: 12px; padding: 24px; border-left: 4px solid #f59e0b; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <div style="width: 40px; height: 40px; background: #fef3c7; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                <i data-lucide="dollar-sign" style="width: 20px; height: 20px; color: #f59e0b;"></i>
                            </div>
                            <div style="font-size: 13px; font-weight: 600; color: #6b7280;">Working Capital</div>
                        </div>
                        <div id="inv-kpi-3" style="font-size: 32px; font-weight: 700; color: #111827; margin-bottom: 4px;">2.456M â‚¬</div>
                        <div style="font-size: 13px; color: #f59e0b;">Locked in inventory</div>
                    </div>
                    <div style="background: white; border-radius: 12px; padding: 24px; border-left: 4px solid #8b5cf6; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <div style="width: 40px; height: 40px; background: #ede9fe; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                <i data-lucide="trending-up" style="width: 20px; height: 20px; color: #8b5cf6;"></i>
                            </div>
                            <div style="font-size: 13px; font-weight: 600; color: #6b7280;">Stock Health</div>
                        </div>
                        <div id="inv-kpi-4" style="font-size: 32px; font-weight: 700; color: #111827; margin-bottom: 4px;">18.5%</div>
                        <div style="font-size: 13px; color: #8b5cf6;">Growth YoY</div>
                    </div>
                </div>

                <!-- Inventory Charts -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                    <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <h3 style="font-size: 16px; font-weight: 600; color: #111827; margin: 0 0 20px 0;">Inventory Turnover by Warehouse</h3>
                        <canvas id="inventoryTurnoverChart" style="max-height: 300px;"></canvas>
                    </div>
                    <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <h3 style="font-size: 16px; font-weight: 600; color: #111827; margin: 0 0 20px 0;">Inventory Capital vs Sales Evolution</h3>
                        <canvas id="inventoryCapitalChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>

                <!-- Inventory Table -->
                <div class="table-wrapper card">
                    <h3 style="font-size: 16px; font-weight: 600; color: #111827; margin: 0 0 20px 0;">Cash Outlook & Inventory Status</h3>
                    <table>
                        <thead>
                            <tr>
                                <th style="text-align: left;">SKU</th>
                                <th style="text-align: left;">Warehouse</th>
                                <th style="text-align: left;">Status</th>
                                <th style="text-align: left;">Net Days</th>
                                <th style="text-align: left;">Turnover</th>
                                <th style="text-align: left;">Trend</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-table">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- AI Reports Section -->
        <div id="ai-reports-section" class="content-section">
    <!-- Main Layout: Sessions (left) | Chat (right) -->
    <div class="ai-reports-layout">
        
        <!-- Left Sidebar: Sessions History -->
        <div class="ai-sessions-panel">
            <div class="ai-sessions-header">
                <h3>Sessions</h3>
                <button class="ai-new-session-btn" id="ai-new-session-btn" title="New Session">
                    <i data-lucide="plus" style="width: 18px; height: 18px;"></i>
                </button>
            </div>

            <!-- Search Sessions -->
            <div class="ai-sessions-search">
                <input type="text" id="ai-sessions-search" class="ai-sessions-search-input" placeholder="Search sessions...">
            </div>

            <!-- Sessions List -->
            <div id="ai-sessions-list" class="ai-sessions-list">
                <div class="ai-empty-sessions">
                    <i data-lucide="message-circle" style="width: 24px; height: 24px; color: #d1d5db;"></i>
                    <p>No sessions yet</p>
                </div>
            </div>

            <!-- Sessions Footer -->
            <div class="ai-sessions-footer">
                <button class="ai-footer-btn" id="ai-clear-sessions-btn">
                    <i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
                    Clear All
                </button>
            </div>
        </div>

        <!-- Middle Column: Chat -->
        <div class="ai-chat-panel">
            <!-- Chat Messages -->
            <div id="ai-chat-messages" class="ai-chat-messages">
                <div class="ai-chat-greeting" style="text-align: center;">
                    <h4>Welcome to AI Reports</h4>
                    <p>I'm your supply chain analyst. Describe what you need and I'll create a personalized report for you.</p>
                    
                    <!-- Quick Prompts -->
                    <div class="ai-quick-prompts">
                        <button class="ai-quick-prompt-btn" onclick="setQuickPrompt('Analyze inventory turnover by country for the last 90 days')">
                            <i data-lucide="package" style="width: 16px; height: 16px;"></i>
                            <span>Inventory Analysis</span>
                        </button>
                        <button class="ai-quick-prompt-btn" onclick="setQuickPrompt('Show supply chain risks and exceptions')">
                            <i data-lucide="alert-triangle" style="width: 16px; height: 16px;"></i>
                            <span>Risk Analysis</span>
                        </button>
                        <button class="ai-quick-prompt-btn" onclick="setQuickPrompt('Compare supplier performance metrics')">
                            <i data-lucide="trending-up" style="width: 16px; height: 16px;"></i>
                            <span>Supplier Report</span>
                        </button>
                        <button class="ai-quick-prompt-btn" onclick="setQuickPrompt('Analyze OTIF performance by customer')">
                            <i data-lucide="target" style="width: 16px; height: 16px;"></i>
                            <span>OTIF Report</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chat Input -->
            <div class="ai-chat-input-area">
                <div class="ai-input-row">
                    <textarea id="ai-chat-input" class="ai-chat-input" placeholder="Describe the report you want to create..." rows="1"></textarea>
                    <button type="button" id="ai-send-button" class="ai-send-button" disabled>
                        <i data-lucide="send" style="width: 16px; height: 16px;"></i>
                    </button>
                </div>
                
                <!-- Agent Selector - Visual Cards -->
                <div class="ai-agents-container">
                    <p style="font-size: 11px; color: #6b7280; margin: 12px 0 8px 0; font-weight: 500;">Select Agent:</p>
                    <div id="ai-agents-list" class="ai-agents-list">
                        <div class="ai-agent-loading">Loading agents...</div>
                    </div>
                </div>
                
                <div class="ai-input-footer">
                    <p style="font-size: 11px; color: #9ca3af; margin: 0;">Shift+Enter for new line</p>
                </div>
            </div>
        </div>

        <!-- Right Column: Report Preview & Insights -->
        <div class="ai-preview-panel">
            <!-- Tabs -->
            <div class="ai-preview-tabs">
                <button class="ai-preview-tab active" data-tab="report">
                    <i data-lucide="bar-chart-3" style="width: 16px; height: 16px;"></i>
                    <span>Report</span>
                </button>
                <button class="ai-preview-tab" data-tab="insights">
                    <i data-lucide="lightbulb" style="width: 16px; height: 16px;"></i>
                    <span>Insights</span>
                </button>
                <button class="ai-preview-tab" data-tab="details">
                    <i data-lucide="info" style="width: 16px; height: 16px;"></i>
                    <span>Details</span>
                </button>
            </div>

            <!-- Tab Content: Report -->
            <div id="ai-report-tab" class="ai-tab-content active">
                <div class="ai-report-header">
                    <h3 id="ai-report-title">Report Preview</h3>
                    <div id="ai-report-actions" class="ai-report-actions" style="display: none;">
                        <button class="ai-action-button" title="Refine report">
                            <i data-lucide="refresh-cw" style="width: 16px; height: 16px;"></i>
                        </button>
                        <button class="ai-action-button" title="Save report">
                            <i data-lucide="save" style="width: 16px; height: 16px;"></i>
                        </button>
                        <button class="ai-action-button primary" title="Export as PDF">
                            <i data-lucide="download" style="width: 16px; height: 16px;"></i>
                        </button>
                    </div>
                </div>

                <div id="ai-report-content" class="ai-report-content">
                    <div class="ai-empty-report">
                        <div style="width: 60px; height: 60px; background: #f0fdf4; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                            <i data-lucide="bar-chart-3" style="width: 32px; height: 32px; color: #10b981;"></i>
                        </div>
                        <h4>No Report Yet</h4>
                        <p>Start chatting to generate your first report</p>
                    </div>
                </div>
            </div>

            <!-- Tab Content: Insights -->
            <div id="ai-insights-tab" class="ai-tab-content">
                <div class="ai-report-header">
                    <h3>Key Insights</h3>
                </div>
                <div id="ai-insights-content" class="ai-insights-content">
                    <div class="ai-empty-insights">
                        <i data-lucide="lightbulb" style="width: 32px; height: 32px; color: #d1d5db;"></i>
                        <p>Insights will appear here</p>
                    </div>
                </div>
            </div>

            <!-- Tab Content: Details -->
            <div id="ai-details-tab" class="ai-tab-content">
                <div class="ai-report-header">
                    <h3>Report Details</h3>
                </div>
                <div id="ai-details-content" class="ai-details-content">
                    <div class="ai-empty-details">
                        <i data-lucide="info" style="width: 32px; height: 32px; color: #d1d5db;"></i>
                        <p>Details will appear here</p>
                    </div>
                </div>
            </div>

            <!-- Processing Status -->
            <div id="ai-processing-status" class="ai-processing-status" style="display: none;">
                <div class="ai-status-header">
                    <h4>Processing</h4>
                </div>
                <div id="ai-status-stages" class="ai-status-stages">
                    <!-- Stages populated dynamically -->
                </div>
            </div>
        </div>
    </div>
    </div>
</div>

<!-- Settings Section -->
<div id="settings-section" class="content-section">
    <div class="settings-container">
        <!-- Sidebar Navigation -->
        <aside class="settings-sidebar">
            <h3 class="settings-sidebar-title">Settings</h3>
            <nav class="settings-nav">
                <a href="#" class="nav-item active" data-section="profile">
                    <i data-lucide="user" style="width: 18px; height: 18px;"></i>
                    <span>Profile</span>
                </a>
                <a href="#" class="nav-item" data-section="security">
                    <i data-lucide="shield" style="width: 18px; height: 18px;"></i>
                    <span>Security</span>
                </a>
                <a href="#" class="nav-item" data-section="notifications">
                    <i data-lucide="bell" style="width: 18px; height: 18px;"></i>
                    <span>Notifications</span>
                </a>
                <a href="#" class="nav-item" data-section="preferences">
                    <i data-lucide="palette" style="width: 18px; height: 18px;"></i>
                    <span>Preferences</span>
                </a>
                {% if user.is_staff or user.is_superuser %}
                <hr class="nav-divider">
                <a href="#" class="nav-item" data-section="users">
                    <i data-lucide="users" style="width: 18px; height: 18px;"></i>
                    <span>User Management</span>
                </a>
                <a href="#" class="nav-item" data-section="activity">
                    <i data-lucide="activity" style="width: 18px; height: 18px;"></i>
                    <span>Activity Log</span>
                </a>
                {% endif %}
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="settings-content">
            <!-- Profile Section -->
            <section class="settings-section" id="profile-section">
                <div class="section-header">
                    <h2 class="section-title">Profile Information</h2>
                    <p class="section-subtitle">Update your personal information and profile details</p>
                </div>

                <!-- Avatar Card -->
                <div class="card">
                    <div class="avatar-upload">
                        <div class="avatar-preview" id="avatarPreview">
                            <i data-lucide="user" style="width: 48px; height: 48px;"></i>
                        </div>
                        <div>
                            <h4>Profile Picture</h4>
                            <p>Upload a new profile picture</p>
                            <input type="file" id="avatarInput" accept="image/*" style="display:none;">
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('avatarInput').click()">
                                <i data-lucide="camera" style="width: 16px; height: 16px;"></i>
                                <span>Upload</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Profile Form -->
                <form id="profileForm" class="card">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>First Name</label>
                            <input type="text" id="firstName" value="{{ user.first_name }}" required>
                        </div>
                        <div class="form-group">
                            <label>Last Name</label>
                            <input type="text" id="lastName" value="{{ user.last_name }}" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="email" value="{{ user.email }}" required>
                    </div>
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" value="{{ user.username }}" disabled>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i data-lucide="save" style="width: 16px; height: 16px;"></i>
                            <span>Save Changes</span>
                        </button>
                    </div>
                </form>
            </section>

            <!-- Security Section -->
            <section class="settings-section hidden" id="security-section">
                <div class="section-header">
                    <h2 class="section-title">Security Settings</h2>
                    <p class="section-subtitle">Manage your password and security preferences</p>
                </div>

                <!-- Change Password Card -->
                <div class="card">
                    <h3>Change Password</h3>
                    <form id="passwordForm">
                        <div class="form-group">
                            <label>Current Password</label>
                            <div class="password-wrapper">
                                <input type="password" id="currentPassword" class="password-field" required>
                                <span class="toggle-password">ðŸ™ˆ</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>New Password</label>
                            <div class="password-wrapper">
                                <input type="password" id="newPassword" class="password-field" required>
                                <span class="toggle-password">ðŸ™ˆ</span>
                            </div>
                            <small>At least 8 characters</small>
                        </div>
                        <div class="form-group">
                            <label>Confirm Password</label>
                            <div class="password-wrapper">
                                <input type="password" id="confirmPassword" class="password-field" required>
                                <span class="toggle-password">ðŸ™ˆ</span>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary btn-sm">
                                <i data-lucide="lock" style="width: 16px; height: 16px;"></i>
                                <span>Update Password</span>
                            </button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Notifications Section -->
            <section class="settings-section hidden" id="notifications-section">
                <div class="section-header">
                    <h2 class="section-title">Notification Preferences</h2>
                    <p class="section-subtitle">Control how and when you receive notifications</p>
                </div>

                <div class="card">
                    <div class="settings-item">
                        <div class="settings-info">
                            <h4>Email Notifications</h4>
                            <p>Receive updates and alerts via email</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" class="notification-toggle" data-type="email" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="settings-item">
                        <div class="settings-info">
                            <h4>Desktop Notifications</h4>
                            <p>Get browser notifications for urgent alerts</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" class="notification-toggle" data-type="desktop">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="settings-item">
                        <div class="settings-info">
                            <h4>Inventory Alerts</h4>
                            <p>Notifications for low stock and updates</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" class="notification-toggle" data-type="inventory" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="settings-item">
                        <div class="settings-info">
                            <h4>Reports Summary</h4>
                            <p>Weekly digest of reports and insights</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" class="notification-toggle" data-type="reports" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </section>

            <!-- Preferences Section -->
            <section class="settings-section hidden" id="preferences-section">
                <div class="section-header">
                    <h2 class="section-title">Display Preferences</h2>
                    <p class="section-subtitle">Customize your experience and interface</p>
                </div>

                <div class="card">
                    <div class="settings-item">
                        <div class="settings-info">
                            <h4>Items Per Page</h4>
                            <p>Number of items displayed in tables and lists</p>
                        </div>
                        <select id="itemsPerPage" style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px;">
                            <option value="10">10 items</option>
                            <option value="25" selected>25 items</option>
                            <option value="50">50 items</option>
                            <option value="100">100 items</option>
                        </select>
                    </div>

                    <div class="settings-item">
                        <div class="settings-info">
                            <h4>Default View</h4>
                            <p>Choose your default dashboard view</p>
                        </div>
                        <select id="defaultView" style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px;">
                            <option value="dashboard" selected>Dashboard</option>
                            <option value="sales">Sales</option>
                            <option value="inventory">Inventory</option>
                            <option value="reports">Reports</option>
                        </select>
                    </div>

                    <div class="settings-item">
                        <div class="settings-info">
                            <h4>Auto-refresh</h4>
                            <p>Automatically refresh data every 5 minutes</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" class="preference-toggle" data-pref="autorefresh" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </section>

            <!-- User Management Section (Admin Only) -->
            {% if user.is_staff or user.is_superuser %}
            <section class="settings-section hidden" id="users-section">
                <div class="section-header">
                    <h2 class="section-title">User Management</h2>
                    <p class="section-subtitle">Manage system users and permissions</p>
                </div>

                <button type="button" class="btn btn-primary" onclick="openAddUserModal()" style="margin-bottom: 24px;">
                    <i data-lucide="user-plus" style="width: 16px; height: 16px;"></i>
                    <span>Add New User</span>
                </button>

                <div class="card table-wrapper">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Name</th>
                                <th>Role</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Activity Log Section (Admin Only) -->
            <section class="settings-section hidden" id="activity-section">
                <div class="section-header">
                    <h2 class="section-title">Activity Log</h2>
                    <p class="section-subtitle">Recent system activity and user actions</p>
                </div>

                <div class="card">
                    <table class="activity-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Action</th>
                                <th>Resource</th>
                                <th>Timestamp</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>{{ user.username }}</td>
                                <td>View</td>
                                <td>Dashboard</td>
                                <td>Just now</td>
                                <td><span class="status-badge success">Success</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
            {% endif %}
        </main>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast hidden">
        <span id="toastMessage"></span>
    </div>
</div>

<!-- Add User Modal -->
<div id="addUserModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h2>Add New User</h2>
            <button type="button" class="modal-close" onclick="closeAddUserModal()">Ã—</button>
        </div>
        <form id="addUserForm">
            <div class="form-group">
                <label>Username *</label>
                <input type="text" id="newUsername" required>
            </div>
            <div class="form-group">
                <label>Email *</label>
                <input type="email" id="newEmail" required>
            </div>
            <div class="form-group">
                <label>First Name</label>
                <input type="text" id="newFirstName">
            </div>
            <div class="form-group">
                <label>Last Name</label>
                <input type="text" id="newLastName">
            </div>
            <div class="form-group">
                <label>Password *</label>
                <input type="password" id="addUserPassword" required>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="newIsStaff">
                    <span>Staff Member (admin access)</span>
                </label>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-outline" onclick="closeAddUserModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add User</button>
            </div>
        </form>
    </div>
</div>

<!-- Company Modal -->
<div id="companyModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>New Company</h2>
            <button class="modal-close" onclick="closeCompanyModal()">Ã—</button>
        </div>
        <form id="companyForm" onsubmit="saveCompany(event)">
            <div class="form-group">
                <label>Company Name *</label>
                <input type="text" id="companyName" required>
            </div>
            <div class="form-group">
                <label>Country *</label>
                <input type="text" id="companyCountry" required>
            </div>
            <div class="form-group">
                <label>City *</label>
                <input type="text" id="companyCity" required>
            </div>
            <div class="form-group">
                <label>Status</label>
                <select id="companyStatus">
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                    <option value="pending">Pending</option>
                </select>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-outline" onclick="closeCompanyModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Company</button>
            </div>
        </form>
    </div>
</div>

<!-- Merge Companies Modal -->
<div id="mergeModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Merge Companies</h2>
            <button class="modal-close" onclick="closeMergeModal()">Ã—</button>
        </div>
        <div style="margin-bottom: 16px; padding: 12px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
            <p style="font-size: 13px; color: #92400e;">âš ï¸ This will merge the source company into the target company. All stores and subsidiaries will be transferred.</p>
        </div>
        <form id="mergeForm" onsubmit="mergeCompanies(event)">
            <div class="form-group">
                <label>Source Company (To merge FROM) *</label>
                <select id="sourceCompany" required>
                    <option value="">Select a company...</option>
                </select>
            </div>
            <div style="text-align: center; margin: 16px 0;">
                <i data-lucide="arrow-down" style="width: 24px; height: 24px; color: #10b981;"></i>
            </div>
            <div class="form-group">
                <label>Target Company (To merge INTO) *</label>
                <select id="targetCompany" required>
                    <option value="">Select a company...</option>
                </select>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-outline" onclick="closeMergeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary" style="background: #ef4444;">Merge Companies</button>
            </div>
        </form>
    </div>
</div>

<!-- Warehouse Location Modal -->
<div id="warehouseModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <div>
                <h2 id="warehouseTitle">Warehouse Location</h2>
                <p id="warehouseSKU" style="font-size: 13px; color: #6b7280; margin-top: 4px;"></p>
            </div>
            <button class="modal-close" onclick="closeWarehouseModal()">Ã—</button>
        </div>
        
        <div id="warehouseContent" style="max-height: 500px; overflow-y: auto;">
            <div class="loading" style="text-align: center; padding: 40px;">Carregando localizaÃ§Ã£o...</div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link rel="stylesheet" href="{% static 'css/settings.css' %}">
<script src="{% static 'js/dashboard.js' %}"></script>
<script src="{% static 'js/ai-reports-new.js' %}"></script>
<script src="{% static 'js/settings.js' %}"></script>
{% endblock %}
